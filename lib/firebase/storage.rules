// firebase/storage.rules
// Firebase Storage security rules for AgriDirect agricultural app

rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper functions for validation
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isValidImageSize() {
      return request.resource.size < 5 * 1024 * 1024; // 5MB limit
    }
    
    function isValidImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    function isValidDocument() {
      return request.resource.contentType.matches('application/pdf') ||
             request.resource.contentType.matches('application/msword') ||
             request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document');
    }
    
    function isValidMLModel() {
      return request.resource.size < 50 * 1024 * 1024 && // 50MB limit
             request.resource.contentType == 'application/octet-stream';
    }

    // User-specific directories
    match /users/{userId}/{allPaths=**} {
      allow read, write: if isOwner(userId);
    }
    
    // User profile pictures
    match /users/{userId}/profile/profile_picture.jpg {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) && isValidImage() && isValidImageSize();
    }
    
    // Disease detection images - user can only access their own
    match /users/{userId}/disease_images/{imageId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) && isValidImage() && isValidImageSize();
      allow delete: if isOwner(userId);
    }
    
    // Crop prediction images - user can only access their own
    match /users/{userId}/crop_images/{imageId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) && isValidImage() && isValidImageSize();
      allow delete: if isOwner(userId);
    }
    
    // User documents (reports, certificates, etc.)
    match /users/{userId}/documents/{documentId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) && isValidDocument();
      allow delete: if isOwner(userId);
    }
    
    // Tool images - readable by all authenticated users, writable by tool owner
    match /tools/{toolId}/{imageId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidImage() && isValidImageSize();
      allow delete: if isAuthenticated(); // Could add owner check if needed
    }
    
    // Marketplace product images - readable by all, writable by authenticated users
    match /marketplace/{productId}/{imageId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidImage() && isValidImageSize();
      allow delete: if isAuthenticated(); // Could add seller check if needed
    }
    
    // Expert consultation documents
    match /consultations/{consultationId}/{documentId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (isValidImage() || isValidDocument());
    }
    
    // News and feed images - readable by all authenticated users
    match /news/{newsId}/{imageId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admin through backend
    }
    
    // Weather data images/charts - readable by all authenticated users
    match /weather/{weatherId}/{imageId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only system generated
    }
    
    // ML models - readable by all authenticated users, not writable
    match /ml_models/{modelName} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admin can upload models
    }
    
    // Farming tips images - readable by all authenticated users
    match /farming_tips/{tipId}/{imageId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admin through backend
    }
    
    // Crop calendar images - readable by all authenticated users
    match /crop_calendar/{calendarId}/{imageId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admin through backend
    }
    
    // System backup files - not accessible to users
    match /system/{allPaths=**} {
      allow read, write: if false;
    }
    
    // Admin uploads - not accessible to regular users
    match /admin/{allPaths=**} {
      allow read, write: if false; // Only server-side admin access
    }
    
    // Temporary uploads - short-lived access
    match /temp/{userId}/{allPaths=**} {
      allow read, write: if isOwner(userId) && isValidImage() && isValidImageSize();
    }
    
    // Public assets (app logos, default images, etc.)
    match /public/{allPaths=**} {
      allow read: if true; // Public read access
      allow write: if false; // Only admin can write
    }
    
    // Chat/message images
    match /messages/{chatId}/{messageId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidImage() && isValidImageSize();
    }
    
    // Analytics and reports - generated by system
    match /reports/{reportId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if false; // Only system generated
    }
    
    // User data exports - users can only access their own
    match /exports/{userId}/{exportId} {
      allow read: if isOwner(userId);
      allow write: if false; // Only system generated
    }
    
    // Feedback attachments
    match /feedback/{feedbackId}/{attachmentId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (isValidImage() || isValidDocument()) && isValidImageSize();
    }
    
    // Default fallback - deny all access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}